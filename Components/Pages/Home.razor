@page "/"
@using Microsoft.AspNetCore.Components.Web
@rendermode InteractiveServer
@inject IHttpClientFactory ClientFactory

<div class="container py-5 text-center">
    <h1 class="display-4 fw-bold text-primary mb-4">Weather Dash</h1>

    <div class="row justify-content-center mb-4">
        <div class="col-md-6">
            <div class="input-group shadow-sm">
                <input type="text" class="form-control" placeholder="Enter city name" @bind="cityName" /><br />
                <button class="btn btn-primary" @onclick="SearchWeather">Search</button>
            </div>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="spinner-border text-primary" role="status"></div>
    }
    else if (weatherData != null)
    {
        <div class="card shadow-lg border-0 rounded-4 mx-auto" style="max-width: 400px;">
            <div class="card-body p-5">
                <h2 class="text-muted">@displayCity</h2>
                <div class="display-1 fw-bold">@weatherData.current_weather.temperature°C</div>
                <p class="badge bg-info text-dark p-2">Wind: @weatherData.current_weather.windspeed km/h</p>
            </div>
        </div>
    }
</div>

@code {
    private string cityName = "";
    private string displayCity = "";
    private bool isLoading = false;
    private WeatherRoot? weatherData;

    private async Task SearchWeather()
    {
        isLoading = true;
        try {
            // Coordinate mapping for cities
            var coords = cityName.ToLower() switch {
                "bengaluru" or "bangalore" => (12.97, 77.59),
                "london" => (51.50, -0.12),
                "tokyo" => (35.68, 139.65),
                "new york" => (40.71, -74.00),
                _ => (12.97, 77.59) // Default to Bengaluru
            };

            var client = ClientFactory.CreateClient();
            var url = $"https://api.open-meteo.com/v1/forecast?latitude={coords.Item1}&longitude={coords.Item2}&current_weather=true";
            
            weatherData = await client.GetFromJsonAsync<WeatherRoot>(url);
            displayCity = cityName;
        }
        catch (Exception ex) {
            Console.WriteLine($"Search error: {ex.Message}");
        }
        finally {
            isLoading = false;
        }
    }

    public class WeatherRoot { public CurrentWeather current_weather { get; set; } = new(); }
    public class CurrentWeather { public double temperature { get; set; } public double windspeed { get; set; } }
}